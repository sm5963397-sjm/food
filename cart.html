<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ff4500">
  <title>Cart ‚Äî EatLo</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --brand:#ff4500; --brand2:#ff7a00; --dark:#12120f; --surface:#1c1c19;
      --card:#242420; --border:rgba(255,255,255,0.08); --text:#f5f5f0;
      --muted:#9e9e90; --success:#00c896; --warning:#ffb800; --danger:#ff4466;
      --r:14px; --rs:10px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    html,body { font-family:'Nunito',sans-serif; background:var(--dark); color:var(--text); min-height:100vh; }

    nav {
      background:rgba(18,18,15,0.97); backdrop-filter:blur(20px);
      padding:12px 20px; display:flex; align-items:center; gap:14px;
      border-bottom:1px solid var(--border); position:sticky; top:0; z-index:200;
    }
    .back-link { color:var(--muted); font-size:1.1rem; text-decoration:none; padding:4px 8px; transition:color 0.2s; }
    .back-link:hover { color:var(--brand); }
    .nav-title { font-size:1.1rem; font-weight:900; }
    .nav-count { margin-left:auto; background:rgba(255,69,0,0.12); color:var(--brand); padding:5px 14px; border-radius:50px; font-size:0.8rem; font-weight:800; }

    .container { max-width:920px; margin:0 auto; padding:20px 16px 260px; }
    @media (min-width:768px) {
      .container { padding-bottom:40px; }
      .cart-layout { display:grid; grid-template-columns:1.4fr 1fr; gap:24px; align-items:start; }
    }

    .store-group { background:var(--card); border:1px solid var(--border); border-radius:var(--r); margin-bottom:14px; overflow:hidden; }
    .sg-header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.02); }
    .sg-emoji { font-size:1.1rem; }
    .sg-name { font-size:0.95rem; font-weight:900; }

    .cart-item { display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border); }
    .cart-item:last-child { border-bottom:none; }
    .ci-img { width:62px; height:62px; border-radius:var(--rs); background:var(--surface) center/cover no-repeat; flex-shrink:0; }
    .ci-info { flex:1; min-width:0; }
    .ci-name { font-weight:800; font-size:0.92rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ci-store { font-size:0.71rem; color:var(--muted); margin-top:1px; }
    .ci-price { color:var(--brand); font-weight:900; font-size:0.92rem; margin-top:4px; }
    .ci-actions { display:flex; align-items:center; gap:8px; flex-shrink:0; }
    .qty-wrap { display:flex; align-items:center; background:var(--surface); border-radius:50px; border:1px solid var(--border); overflow:hidden; }
    .qty-btn { width:32px; height:32px; border:none; background:transparent; color:var(--text); font-size:1.1rem; font-weight:900; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
    .qty-btn:hover { background:rgba(255,69,0,0.15); color:var(--brand); }
    .qty-num { min-width:28px; text-align:center; font-weight:900; font-size:0.92rem; }
    .remove-btn { width:32px; height:32px; border-radius:8px; border:none; background:rgba(255,68,102,0.1); color:var(--danger); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; font-size:0.85rem; }
    .remove-btn:hover { background:var(--danger); color:white; }

    .summary-card { background:var(--card); border:1px solid var(--border); border-radius:var(--r); padding:22px; position:sticky; top:76px; }
    .summary-title { font-size:1rem; font-weight:900; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
    .summary-title i { color:var(--brand); }
    .sum-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-size:0.88rem; color:var(--muted); }
    .sum-row.total { border-top:1px dashed var(--border); padding-top:14px; margin-top:8px; color:var(--text); font-weight:900; font-size:1.05rem; }
    .sum-row.total span:last-child { color:var(--brand); font-size:1.25rem; }
    hr.divider { border:none; border-top:1px solid var(--border); margin:16px 0; }

    .form-label { font-size:0.75rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; margin-top:12px; display:flex; align-items:center; gap:5px; }
    .form-label .req { color:var(--brand); }
    .finput {
      width:100%; background:var(--surface); border:2px solid var(--border);
      border-radius:var(--rs); padding:12px 15px; font-family:inherit;
      font-size:0.9rem; color:var(--text); transition:all 0.2s; display:block;
      -webkit-appearance:none;
    }
    .finput:focus { outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(255,69,0,0.1); }
    .finput::placeholder { color:var(--muted); }
    .finput.invalid { border-color:var(--danger) !important; animation:shake 0.35s ease; }
    textarea.finput { resize:vertical; min-height:64px; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-6px)} 40%,80%{transform:translateX(6px)} }

    .loc-section { margin:6px 0; }
    .loc-required-note {
      background:rgba(255,69,0,0.07); border:1px solid rgba(255,69,0,0.25);
      border-radius:8px; padding:8px 12px; font-size:0.74rem; color:var(--brand);
      font-weight:700; display:flex; align-items:center; gap:6px; margin-bottom:8px;
    }
    .gps-btn {
      width:100%; padding:12px 16px; background:rgba(0,200,150,0.07);
      border:2px dashed rgba(0,200,150,0.4); border-radius:var(--rs);
      color:var(--success); font-family:inherit; font-weight:800; font-size:0.86rem;
      cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;
      transition:all 0.2s; margin-bottom:8px;
    }
    .gps-btn:hover:not(:disabled) { background:rgba(0,200,150,0.14); border-color:rgba(0,200,150,0.6); }
    .gps-btn:disabled { opacity:0.65; cursor:not-allowed; }
    .gps-btn.captured { border-style:solid; border-color:var(--success); background:rgba(0,200,150,0.12); }

    .loc-box {
      background:rgba(0,200,150,0.06); border:1.5px solid rgba(0,200,150,0.3);
      border-radius:var(--rs); padding:10px 14px; margin-bottom:8px;
      display:none; align-items:flex-start; gap:10px;
    }
    .loc-box.show { display:flex; }
    .loc-box i { color:var(--success); font-size:0.9rem; margin-top:2px; flex-shrink:0; }
    .loc-box-text { flex:1; min-width:0; }
    .loc-box-text strong { font-size:0.79rem; font-weight:800; display:block; line-height:1.35; word-break:break-word; }
    .loc-box-text small { font-size:0.7rem; color:var(--muted); }
    .loc-box-clear { background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:0.9rem; padding:2px 6px; flex-shrink:0; }
    .loc-box-clear:hover { color:var(--danger); }

    .or-divider { display:flex; align-items:center; gap:8px; margin:10px 0 8px; }
    .or-divider::before,.or-divider::after { content:''; flex:1; height:1px; background:var(--border); }
    .or-divider span { font-size:0.72rem; color:var(--muted); font-weight:700; white-space:nowrap; }

    .checkout-btn {
      width:100%; padding:15px; background:linear-gradient(135deg, var(--brand), var(--brand2));
      color:white; border:none; border-radius:50px; font-family:inherit;
      font-size:1rem; font-weight:900; cursor:pointer; margin-top:8px;
      box-shadow:0 8px 24px rgba(255,69,0,0.3); transition:all 0.2s;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .checkout-btn:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 12px 32px rgba(255,69,0,0.4); }
    .checkout-btn:active:not(:disabled) { transform:scale(0.98); }
    .checkout-btn:disabled { background:linear-gradient(135deg,#3a3935,#4a4945); box-shadow:none; cursor:not-allowed; transform:none; opacity:0.8; }

    .empty-cart { text-align:center; padding:80px 20px; }
    .empty-cart .icon { font-size:3.5rem; margin-bottom:16px; opacity:0.2; }
    .empty-cart h3 { font-size:1.3rem; font-weight:800; color:var(--muted); }
    .empty-cart p { color:var(--muted); font-size:0.9rem; margin:8px 0 24px; }
    .browse-btn {
      display:inline-flex; align-items:center; gap:8px;
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      color:white; padding:13px 28px; border-radius:50px; text-decoration:none;
      font-weight:800; font-size:0.9rem; box-shadow:0 6px 20px rgba(255,69,0,0.3);
    }

    .mobile-checkout {
      display:none; position:fixed; bottom:0; left:0; right:0; z-index:500;
      background:rgba(13,13,11,0.99); backdrop-filter:blur(20px);
      border-top:2px solid var(--border); padding:14px 16px 24px;
      max-height:90vh; overflow-y:auto;
    }
    @media (max-width:767px) {
      .mobile-checkout { display:block; }
      .summary-card { display:none; }
    }
    .mob-total-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .mob-total-bar span { font-size:0.82rem; color:var(--muted); font-weight:700; }
    .mob-total-bar strong { font-size:1.15rem; color:var(--brand); font-weight:900; }
    .mob-form { display:none; }
    .mob-form.open { display:block; animation:fadeUp 0.25s ease; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    .placing-overlay {
      display:none; position:fixed; inset:0; z-index:9000;
      background:rgba(0,0,0,0.82); backdrop-filter:blur(8px);
      flex-direction:column; align-items:center; justify-content:center; gap:18px;
    }
    .placing-overlay.show { display:flex; }
    .placing-overlay h3 { font-size:1.1rem; font-weight:800; }
    .placing-overlay p { color:var(--muted); font-size:0.85rem; text-align:center; max-width:260px; }
    .spinner { width:52px; height:52px; border:4px solid rgba(255,69,0,0.2); border-top-color:var(--brand); border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to{transform:rotate(360deg)} }

    .toast {
      position:fixed; bottom:240px; left:50%; transform:translateX(-50%) translateY(12px);
      background:var(--surface); color:var(--text); border:1px solid var(--border);
      padding:10px 20px; border-radius:50px; font-weight:700; font-size:0.85rem;
      z-index:9999; opacity:0; transition:all 0.3s; pointer-events:none;
      white-space:nowrap; box-shadow:0 8px 24px rgba(0,0,0,0.5); max-width:90vw; text-align:center;
    }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    .toast.success { background:#00a876; color:white; border-color:transparent; }
    .toast.error { background:var(--danger); color:white; border-color:transparent; }
    @media (min-width:768px) { .toast { bottom:30px; } }
  </style>
</head>
<body>

<nav>
  <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i></a>
  <span class="nav-title">Your Cart</span>
  <span class="nav-count" id="nav-count">0 items</span>
</nav>

<div class="container" id="main-container"></div>

<!-- MOBILE BOTTOM SHEET -->
<div class="mobile-checkout" id="mob-checkout" style="display:none">
  <div class="mob-total-bar">
    <span>Total (incl. ‚Çπ40 delivery)</span>
    <strong id="mob-total-val">‚Çπ0</strong>
  </div>

  <div class="mob-form" id="mob-form">
    <div class="form-label"><i class="fas fa-user" style="color:var(--brand)"></i> Full Name <span class="req">*</span></div>
    <input class="finput" type="text" id="mob-name" placeholder="Enter your full name" autocomplete="name">

    <div class="form-label"><i class="fas fa-phone" style="color:var(--brand)"></i> Phone Number <span class="req">*</span></div>
    <input class="finput" type="tel" id="mob-phone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric" autocomplete="tel">

    <div class="form-label"><i class="fas fa-location-dot" style="color:var(--brand)"></i> Delivery Location <span class="req">*</span></div>
    <div class="loc-required-note"><i class="fas fa-circle-exclamation"></i> Location is mandatory to place your order</div>

    <button class="gps-btn" id="mob-gps-btn" type="button" onclick="getGPS('mob')">
      <i class="fas fa-location-crosshairs"></i> Detect My Current Location
    </button>
    <div class="loc-box" id="mob-loc-box">
      <i class="fas fa-circle-check"></i>
      <div class="loc-box-text">
        <strong id="mob-loc-name">‚Äî</strong>
        <small id="mob-loc-coords"></small>
      </div>
      <button class="loc-box-clear" type="button" onclick="clearGPS('mob')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="or-divider"><span>OR type address manually</span></div>
    <textarea class="finput" id="mob-address" placeholder="House no, street, area, landmark, city..." rows="2"></textarea>

    <button class="checkout-btn" id="mob-place-btn" type="button" onclick="placeOrder('mob')">
      <i class="fas fa-bag-shopping"></i> Place Order Now
    </button>
  </div>

  <button class="checkout-btn" id="mob-proceed-btn" type="button" onclick="toggleMobForm()" style="display:flex">
    <i class="fas fa-arrow-right"></i> Proceed to Checkout
  </button>
</div>

<!-- OVERLAY -->
<div class="placing-overlay" id="placing-overlay">
  <div class="spinner"></div>
  <h3>Placing your order...</h3>
  <p>Please don't close or refresh this page</p>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const FC = {
    apiKey:"AIzaSyA9ow668puMztfqJcfAHkJcXXBlWjWFIx8",
    authDomain:"eatlo-ec2f6.firebaseapp.com",
    projectId:"eatlo-ec2f6",
    storageBucket:"eatlo-ec2f6.firebasestorage.app",
    messagingSenderId:"298601218259",
    appId:"1:298601218259:web:d8b54f5322139f42881426"
  };

  // Safe init ‚Äî never init twice
  const firebaseApp = getApps().length === 0 ? initializeApp(FC) : getApps()[0];
  const db = getFirestore(firebaseApp);

  const DELIVERY_FEE = 40;

  // Load cart safely
  let cart = [];
  try {
    const raw = localStorage.getItem('eatlo_cart');
    const parsed = raw ? JSON.parse(raw) : [];
    cart = Array.isArray(parsed) ? parsed : [];
  } catch(e) { cart = []; }

  // GPS state per mode (mob/desk)
  const gps = { mob: null, desk: null };

  // ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
  function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function toast(msg, type) {
    const el = document.getElementById('toast');
    if (!el) return;
    el.textContent = msg;
    el.className = 'toast show' + (type ? ' '+type : '');
    clearTimeout(window._tt);
    window._tt = setTimeout(() => { el.className = 'toast'; }, 3500);
  }

  function saveCart() { localStorage.setItem('eatlo_cart', JSON.stringify(cart)); }

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
  function render() {
    const totalQty = cart.reduce((s,i) => s + (Number(i.quantity)||1), 0);
    const nc = document.getElementById('nav-count');
    if (nc) nc.textContent = totalQty + (totalQty === 1 ? ' item' : ' items');

    const mobSheet = document.getElementById('mob-checkout');

    if (cart.length === 0) {
      if (mobSheet) mobSheet.style.display = 'none';
      document.getElementById('main-container').innerHTML = `
        <div class="empty-cart">
          <div class="icon">üõí</div>
          <h3>Your cart is empty</h3>
          <p>Add something delicious first!</p>
          <a href="index.html" class="browse-btn"><i class="fas fa-arrow-left"></i> Browse Menu</a>
        </div>`;
      return;
    }

    if (mobSheet) mobSheet.style.display = 'block';

    // Group by store
    const grouped = {};
    cart.forEach(item => {
      const k = item.storeId || '__x__';
      if (!grouped[k]) grouped[k] = { name: item.storeName || 'Restaurant', items: [] };
      grouped[k].items.push(item);
    });

    const subtotal   = cart.reduce((s,i) => s + (Number(i.price)||0)*(Number(i.quantity)||1), 0);
    const grandTotal = subtotal + DELIVERY_FEE;

    let cartHtml = '';
    Object.values(grouped).forEach(g => {
      cartHtml += `
        <div class="store-group">
          <div class="sg-header"><span class="sg-emoji">üç¥</span><span class="sg-name">${esc(g.name)}</span></div>
          ${g.items.map(item => `
            <div class="cart-item">
              <div class="ci-img" style="background-image:url('${esc(item.image||'')}')"></div>
              <div class="ci-info">
                <div class="ci-name">${esc(item.name||'Item')}</div>
                <div class="ci-store">${esc(item.storeName||'')}</div>
                <div class="ci-price">‚Çπ${(Number(item.price)||0)*(Number(item.quantity)||1)}</div>
              </div>
              <div class="ci-actions">
                <div class="qty-wrap">
                  <button class="qty-btn" type="button" onclick="changeQty('${esc(item.id)}',-1)">‚àí</button>
                  <span class="qty-num">${Number(item.quantity)||1}</span>
                  <button class="qty-btn" type="button" onclick="changeQty('${esc(item.id)}',1)">+</button>
                </div>
                <button class="remove-btn" type="button" onclick="removeItem('${esc(item.id)}')"><i class="fas fa-trash"></i></button>
              </div>
            </div>`).join('')}
        </div>`;
    });

    const deskForm = `
      <div class="summary-card">
        <div class="summary-title"><i class="fas fa-receipt"></i> Order Summary</div>
        <div class="sum-row"><span>Subtotal (${totalQty} items)</span><span>‚Çπ${subtotal}</span></div>
        <div class="sum-row"><span>Delivery fee</span><span>‚Çπ${DELIVERY_FEE}</span></div>
        <div class="sum-row total"><span>Total</span><span>‚Çπ${grandTotal}</span></div>
        <hr class="divider">

        <div class="form-label"><i class="fas fa-user" style="color:var(--brand)"></i> Full Name <span class="req">*</span></div>
        <input class="finput" type="text" id="desk-name" placeholder="Enter your full name" autocomplete="name">

        <div class="form-label"><i class="fas fa-phone" style="color:var(--brand)"></i> Phone Number <span class="req">*</span></div>
        <input class="finput" type="tel" id="desk-phone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric">

        <div class="form-label"><i class="fas fa-location-dot" style="color:var(--brand)"></i> Delivery Location <span class="req">*</span></div>
        <div class="loc-required-note"><i class="fas fa-circle-exclamation"></i> Location is mandatory to place your order</div>

        <button class="gps-btn" id="desk-gps-btn" type="button" onclick="getGPS('desk')">
          <i class="fas fa-location-crosshairs"></i> Detect My Current Location
        </button>
        <div class="loc-box" id="desk-loc-box">
          <i class="fas fa-circle-check"></i>
          <div class="loc-box-text">
            <strong id="desk-loc-name">‚Äî</strong>
            <small id="desk-loc-coords"></small>
          </div>
          <button class="loc-box-clear" type="button" onclick="clearGPS('desk')"><i class="fas fa-xmark"></i></button>
        </div>
        <div class="or-divider"><span>OR type address manually</span></div>
        <textarea class="finput" id="desk-address" placeholder="House no, street, area, landmark, city..." rows="2"></textarea>

        <button class="checkout-btn" id="desk-place-btn" type="button" onclick="placeOrder('desk')">
          <i class="fas fa-bag-shopping"></i> Place Order Now
        </button>
      </div>`;

    document.getElementById('main-container').innerHTML =
      `<div class="cart-layout"><div>${cartHtml}</div>${deskForm}</div>`;

    // Update mobile total
    const mt = document.getElementById('mob-total-val');
    if (mt) mt.textContent = '‚Çπ' + grandTotal;

    // Pre-fill saved phone
    const ph = localStorage.getItem('eatlo_phone');
    if (ph) {
      ['desk-phone','mob-phone'].forEach(id => {
        const el = document.getElementById(id); if (el && !el.value) el.value = ph;
      });
    }

    // Input validation listeners
    document.querySelectorAll('input[type=tel]').forEach(el => {
      el.addEventListener('input', () => { el.value = el.value.replace(/\D/g,'').slice(0,10); el.classList.remove('invalid'); });
    });
    document.querySelectorAll('.finput').forEach(el => {
      el.addEventListener('focus', () => el.classList.remove('invalid'));
    });
  }

  // ‚îÄ‚îÄ CART ACTIONS ‚îÄ‚îÄ
  window.changeQty = function(id, delta) {
    const idx = cart.findIndex(i => i.id === id);
    if (idx === -1) return;
    cart[idx].quantity = (Number(cart[idx].quantity)||1) + delta;
    if (cart[idx].quantity <= 0) cart.splice(idx, 1);
    saveCart(); render();
  };

  window.removeItem = function(id) {
    cart = cart.filter(i => i.id !== id);
    saveCart(); render();
    toast('Item removed');
  };

  // ‚îÄ‚îÄ MOBILE TOGGLE ‚îÄ‚îÄ
  window.toggleMobForm = function() {
    const form = document.getElementById('mob-form');
    const btn  = document.getElementById('mob-proceed-btn');
    if (!form || !btn) return;
    const opening = !form.classList.contains('open');
    form.classList.toggle('open', opening);
    btn.style.display = opening ? 'none' : 'flex';
  };

  // ‚îÄ‚îÄ GPS ‚îÄ‚îÄ
  window.getGPS = function(mode) {
    const btn = document.getElementById(mode + '-gps-btn');
    if (!btn) return;

    if (!navigator.geolocation) {
      toast('GPS not supported. Please type your address below.', 'error');
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch" style="animation:spin 0.8s linear infinite;display:inline-block"></i> Detecting...';

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = parseFloat(pos.coords.latitude.toFixed(6));
        const lng = parseFloat(pos.coords.longitude.toFixed(6));
        let address = `${lat}, ${lng}`;

        try {
          const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`, {
            headers: { 'Accept-Language': 'en' }
          });
          const d = await r.json();
          if (d && d.display_name) address = d.display_name;
        } catch(_) {}

        gps[mode] = { lat, lng, address };

        const box = document.getElementById(mode + '-loc-box');
        const nm  = document.getElementById(mode + '-loc-name');
        const co  = document.getElementById(mode + '-loc-coords');
        if (box) box.classList.add('show');
        if (nm)  nm.textContent  = address.length > 75 ? address.slice(0,75)+'‚Ä¶' : address;
        if (co)  co.textContent  = `GPS: ${lat}, ${lng}`;

        btn.disabled = false;
        btn.classList.add('captured');
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Location Captured ‚Äî Tap to Refresh';
        toast('üìç Location captured!', 'success');
      },
      (err) => {
        btn.disabled = false;
        btn.classList.remove('captured');
        btn.innerHTML = '<i class="fas fa-location-crosshairs"></i> Detect My Current Location';
        const msgs = {
          1: 'Permission denied. Allow location in browser settings, or type address.',
          2: 'Location unavailable. Please type your address.',
          3: 'Location timed out. Try again or type your address.'
        };
        toast(msgs[err.code] || 'Could not get location. Type address instead.', 'error');
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  };

  window.clearGPS = function(mode) {
    gps[mode] = null;
    const box = document.getElementById(mode + '-loc-box');
    if (box) box.classList.remove('show');
    const btn = document.getElementById(mode + '-gps-btn');
    if (btn) {
      btn.classList.remove('captured');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-location-crosshairs"></i> Detect My Current Location';
    }
  };

  // ‚îÄ‚îÄ PLACE ORDER ‚îÄ‚îÄ
  window.placeOrder = async function(mode) {
    if (cart.length === 0) { toast('Cart is empty!', 'error'); return; }

    const pre = mode === 'mob' ? 'mob-' : 'desk-';
    const nameEl    = document.getElementById(pre + 'name');
    const phoneEl   = document.getElementById(pre + 'phone');
    const addressEl = document.getElementById(pre + 'address');

    const name   = (nameEl?.value || '').trim();
    const phone  = (phoneEl?.value || '').replace(/\D/g,'');
    const manual = (addressEl?.value || '').trim();
    const gpsFix = gps[mode];

    // Validate name
    if (!name) {
      nameEl?.classList.add('invalid'); nameEl?.scrollIntoView({ behavior:'smooth', block:'center' }); nameEl?.focus();
      toast('Please enter your full name', 'error'); return;
    }

    // Validate phone
    if (phone.length !== 10) {
      phoneEl?.classList.add('invalid'); phoneEl?.scrollIntoView({ behavior:'smooth', block:'center' }); phoneEl?.focus();
      toast('Enter a valid 10-digit phone number', 'error'); return;
    }

    // Validate location ‚Äî MANDATORY (GPS or manual, but not empty)
    if (!gpsFix && !manual) {
      toast('üìç Location is required! Tap "Detect My Location" or type your address.', 'error');
      const gBtn = document.getElementById(pre + 'gps-btn');
      if (gBtn) { gBtn.style.borderColor = 'var(--danger)'; gBtn.style.color = 'var(--danger)'; setTimeout(() => { gBtn.style.borderColor=''; gBtn.style.color=''; }, 2500); }
      addressEl?.classList.add('invalid');
      addressEl?.scrollIntoView({ behavior:'smooth', block:'center' });
      return;
    }
    if (!gpsFix && manual.length < 5) {
      addressEl?.classList.add('invalid'); addressEl?.focus();
      toast('Please enter a complete address', 'error'); return;
    }

    // Build final address
    let finalAddress = gpsFix
      ? gpsFix.address + (manual ? ' | Note: ' + manual : '') + ` [GPS: ${gpsFix.lat}, ${gpsFix.lng}]`
      : manual;

    // Show overlay
    document.getElementById('placing-overlay').classList.add('show');
    const placeBtn = document.getElementById(pre + 'place-btn');
    if (placeBtn) { placeBtn.disabled = true; placeBtn.innerHTML = '<i class="fas fa-circle-notch" style="animation:spin 0.8s linear infinite;display:inline-block"></i> Placing...'; }

    const subtotal   = cart.reduce((s,i) => s+(Number(i.price)||0)*(Number(i.quantity)||1), 0);
    const grandTotal = subtotal + DELIVERY_FEE;

    // Group by store
    const storeGroups = {};
    cart.forEach(item => {
      const sid = item.storeId || '__unknown__';
      if (!storeGroups[sid]) storeGroups[sid] = { storeId: sid, storeName: item.storeName || 'Unknown Store', items: [] };
      storeGroups[sid].items.push({ name: item.name||'', price: Number(item.price)||0, quantity: Number(item.quantity)||1, image: item.image||'' });
    });

    const orderDoc = {
      name, phone,
      address: finalAddress,
      location: gpsFix ? { lat: gpsFix.lat, lng: gpsFix.lng, method:'gps' } : { method:'manual' },
      items: cart.map(i => ({
        id: i.id||'', name: i.name||'', price: Number(i.price)||0,
        quantity: Number(i.quantity)||1, image: i.image||'',
        storeId: i.storeId||'', storeName: i.storeName||''
      })),
      storeGroups: Object.values(storeGroups),
      subtotal, deliveryFee: DELIVERY_FEE, total: grandTotal,
      status: 'Confirmed',
      createdAt: new Date().toISOString(),
      date: new Date().toLocaleString('en-IN', { dateStyle:'medium', timeStyle:'short' })
    };

    try {
      const ref = await addDoc(collection(db, 'orders'), orderDoc);
      localStorage.setItem('eatlo_phone', phone);
      localStorage.removeItem('eatlo_cart');
      window.location.href = 'order-success.html?id=' + ref.id;
    } catch(err) {
      console.error('Order error:', err);
      document.getElementById('placing-overlay').classList.remove('show');
      if (placeBtn) { placeBtn.disabled = false; placeBtn.innerHTML = '<i class="fas fa-bag-shopping"></i> Place Order Now'; }
      toast('Failed: ' + (err.message || 'Check internet & try again'), 'error');
    }
  };

  render();
</script>
</body>
</html>
